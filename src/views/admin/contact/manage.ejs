<%- include('../layouts/admin', { title: 'Manage Contacts', style: '', script:
'', content: `
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header" style="background-color: white; color: black">
          <h3 class="card-title mb-0">Contact Information</h3>
        </div>
        <div class="card-body">
          <div id="alertMessage" class="alert" style="display: none"></div>
          <form id="contactForm" action="/admin/contact/update" method="POST">
            <div class="row">
              <div class="col-md-12 mb-3">
                <label for="address" class="form-label">Address</label>
                <textarea
                  class="form-control"
                  id="address"
                  name="address"
                  rows="2"
                  required
                >
${contact?.address || ''}</textarea
                >
              </div>
              <div class="col-md-6 mb-3">
                <label for="phone" class="form-label">Accounts</label>
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="fas fa-phone"></i
                  ></span>
                  <input
                    type="tel"
                    class="form-control"
                    id="Accounts"
                    name="Accounts"
                    value="${contact?.Accounts || ''}"
                    required
                  />
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="phone" class="form-label">Transport</label>
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="fas fa-phone"></i
                  ></span>
                  <input
                    type="tel"
                    class="form-control"
                    id="Transport"
                    name="Transport"
                    value="${contact?.Transport || ''}"
                    required
                  />
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="phone" class="form-label">Reception</label>
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="fas fa-phone"></i
                  ></span>
                  <input
                    type="tel"
                    class="form-control"
                    id="Reception"
                    name="Reception"
                    value="${contact?.Reception || ''}"
                    required
                  />
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="email" class="form-label">Email</label>
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="fas fa-envelope"></i
                  ></span>
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    name="email"
                    value="${contact?.email || ''}"
                    required
                  />
                </div>
              </div>
              <div class="col-12 mt-4">
                <h4>Social Media Links</h4>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="facebook" class="form-label">Facebook</label>
                    <div class="input-group">
                      <span class="input-group-text"
                        ><i class="fab fa-facebook"></i
                      ></span>
                      <input
                        type="url"
                        class="form-control"
                        id="facebook"
                        name="socialLinks[facebook]"
                        value="${contact?.socialLinks?.facebook || '#'}"
                      />
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="twitter" class="form-label">Twitter</label>
                    <div class="input-group">
                      <span class="input-group-text"
                        ><i class="fab fa-twitter"></i
                      ></span>
                      <input
                        type="url"
                        class="form-control"
                        id="twitter"
                        name="socialLinks[twitter]"
                        value="${contact?.socialLinks?.twitter || '#'}"
                      />
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="instagram" class="form-label">Instagram</label>
                    <div class="input-group">
                      <span class="input-group-text"
                        ><i class="fab fa-instagram"></i
                      ></span>
                      <input
                        type="url"
                        class="form-control"
                        id="instagram"
                        name="socialLinks[instagram]"
                        value="${contact?.socialLinks?.instagram || '#'}"
                      />
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="linkedin" class="form-label">LinkedIn</label>
                    <div class="input-group">
                      <span class="input-group-text"
                        ><i class="fab fa-linkedin"></i
                      ></span>
                      <input
                        type="url"
                        class="form-control"
                        id="linkedin"
                        name="socialLinks[linkedin]"
                        value="${contact?.socialLinks?.linkedin || '#'}"
                      />
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="latitude" class="form-label">Latitude</label>
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="fas fa-map-marker-alt"></i
                  ></span>
                  <input
                    type="number"
                    step="any"
                    class="form-control"
                    id="latitude"
                    name="latitude"
                    value="${contact?.latitude || 0}"
                    required
                  />
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="longitude" class="form-label">Longitude</label>
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="fas fa-map-marker-alt"></i
                  ></span>
                  <input
                    type="number"
                    step="any"
                    class="form-control"
                    id="longitude"
                    name="longitude"
                    value="${contact?.longitude || 0}"
                    required
                  />
                </div>
              </div>
            </div>
            <div class="d-flex justify-content-end">
              <button type="submit" class="btn bg-gradient-primary">
                <i class="fas fa-save me-2"></i>Update Contact Information
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header" style="background-color: white; color: black">
          <h3 class="card-title mb-0">Contact Form Submissions</h3>
          <div class="d-flex justify-content-end">
            <!-- <a
              href="/admin/contact/submissions"
              class="btn btn-sm bg-gradient-info"
            >
              <i class="fas fa-external-link-alt me-2"></i>View All Submissions
            </a> -->
          </div>
        </div>
        <div class="card-body">
          ${ contact?.formSubmissions?.length > 0 ? `
          <div class="table-responsive">
            <table
              class="table table-striped table-hover align-items-center mb-0"
            >
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Subject</th>
                  <th>Message</th>
                </tr>
              </thead>
              <tbody>
                ${contact.formSubmissions .sort((a, b) => new Date(b.createdAt)
                - new Date(a.createdAt)) .map((submission) => `
                <tr>
                  <td>
                    ${new Date(submission.createdAt).toLocaleDateString()}<br />
                    <small class="text-muted"
                      >${new
                      Date(submission.createdAt).toLocaleTimeString()}</small
                    >
                  </td>
                  <td>${submission.name}</td>
                  <td>${submission.email}</td>
                  <td>${submission.subject}</td>
                  <td>${submission.message}</td>
                </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          ` : `
          <div></div>
          ` }
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document
    .getElementById("contactForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();
      try {
        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => {
          if (key.startsWith("socialLinks[")) {
            if (!data.socialLinks) data.socialLinks = {};
            const match = key.match(/\[(.*?)\]/);
            if (!match || !match[1]) continue;
            const socialKey = match[1];
            data.socialLinks[socialKey] = value;
          } else {
            data[key] = value;
          }
        });

        const response = await fetch("/admin/contact/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(
            result.message || "Failed to update contact information"
          );
        }

        const alertDiv = document.getElementById("alertMessage");
        alertDiv.className = "alert alert-success";
        alertDiv.innerHTML =
          '<i class="fas fa-check-circle me-2"></i>' + result.message;
        alertDiv.style.display = "block";

        // Redirect to the specified URL after successful update
        if (result.redirectUrl) {
          setTimeout(() => window.location.href = result.redirectUrl, 1000);
        }
        // setTimeout(() => (alertDiv.style.display = "none"), 3000);

        // Redirect to manage page after successful update
        setTimeout(() => window.location.href = '/admin/contact/manage', 1000);
      } catch (error) {
        const alertDiv = document.getElementById("alertMessage");
        alertDiv.className = "alert alert-danger";
        alertDiv.innerHTML =
          '<i class="fas fa-exclamation-circle me-2"></i>' + error.message;
        alertDiv.style.display = "block";
        setTimeout(() => (alertDiv.style.display = "none"), 3000);
      }
    });
</script>
`}) %>
